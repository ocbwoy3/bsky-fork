name: Build Unsigned IPA

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        description: Build profile to use
        options:
          - testflight
          - production

jobs:
  build:
    name: Build Bluesky.ipa (unsigned)
    runs-on: macos-15

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: 🔧 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn

      - name: 🪛 Setup jq
        uses: dcarbone/install-jq-action@v2

      - name: ⛏️ Setup EAS local builds
        run: yarn global add eas-cli eas-cli-local-build-plugin

      - name: ⚙️ Install dependencies
        run: yarn install

      - name: 🛠 Install iOS build dependencies
        run: |
          brew install cocoapods
          cd ios && pod install && cd ..

      - name: 🔤 Compile translations
        run: yarn intl:build 2>&1 | tee i18n.log

      - name: Check for i18n compilation errors
        run: |
          if grep -q "invalid syntax" "i18n.log"; then
            echo "\n\nFound compilation errors!\n\n"
            exit 1
          else
            echo "\n\nNo compilation errors!\n\n"
          fi

      - name: ✏️ Write environment variables
        id: env
        run: |
          echo "# ocbwoy3 was here" > .env
          echo "EXPO_PUBLIC_RELEASE_VERSION=$(jq -r '.version' package.json)" >> .env
          echo "EXPO_PUBLIC_RELEASE_VERSION=$(jq -r '.version' package.json)" >> $GITHUB_OUTPUT
          echo "EXPO_PUBLIC_BUNDLE_IDENTIFIER=$(git rev-parse HEAD)" >> .env
          echo "EXPO_PUBLIC_BUNDLE_IDENTIFIER=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "EXPO_PUBLIC_BUNDLE_DATE=$(date -u +"%y%m%d%H")" >> .env
          echo "{}" > google-services.json

      - name: 🏗️ Local EAS Build (Unsigned)
        run: |
          yarn use-build-number-with-bump
          eas build -p ios \
            --profile ${{ inputs.profile || 'testflight' }} \
            --local \
            --skip-credentials \
            --output build.ipa \
            --non-interactive

      - name: 📦 Upload to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          files: build.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
